name: Stable Release

on:
  workflow_dispatch:
  schedule:
    # This cron job runs at 00:00 on the first day of every month
    - cron: '0 0 1 * *'

jobs:
  stable-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Bun
        uses: oven-sh/setup-bun@v1
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.node-version'
          registry-url: 'https://registry.npmjs.org'
      - run: bun install
      - name: Check for canary releases
        id: canary-check
        run: |
          CANARY_EXISTS=$(node scripts/check-canary.js) # This script should output "true" or "false"
          echo "CANARY_EXISTS=$CANARY_EXISTS" >> $GITHUB_ENV
      - name: Test
        run: bun test
      - name: Build & Publish Latest if Canary Exists
        if: env.CANARY_EXISTS == 'true'
        run: |
          VERSION=$(node scripts/determine-next-version.js)
          echo "VERSION=$VERSION" >> $GITHUB_ENV

          cd library
          bun run build

          # Set the Git user
          git config user.name github-actions
          git config user.email github-actions@github.com

          yarn version --new-version $VERSION
          yarn publish --tag latest

          # Get last tag name to compare the history
          LAST_TAG=$(git describe --tags --abbrev=0)

          # Generate release notes from commits
          echo "RELEASE_NOTES=$(git log ${LAST_TAG}..HEAD --pretty=format:'* %s (%h)' --reverse)" >> $GITHUB_ENV

          # Push the tag to the repository
          git push origin $VERSION
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        if: env.CANARY_EXISTS == 'true'
        with:
          tag: ${{ env.VERSION }}
          body: ${{ env.RELEASE_NOTES }}
